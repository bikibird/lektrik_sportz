pico-8 cartridge // http://www.pico-8.com
version 34
-- lektrik sportz game
-- by bikibird

-- 3d effects courtesy @mot https://www.lexaloffle.com/bbs/?tid=37982
__lua__
-- instant 3d+!

do
	-- parameters
	p3d={
	 vanish={x=64,y=0}, -- vanishing pt
	 d=128,             -- screen dist in pixels
	 near=1,            -- near plane z
	 camyoff=32,        -- added to cam y pos
	 camheight=32       -- camera height
	}
   
	-- save 2d versions
	map2d,spr2d,sspr2d,pset2d,camera2d=map,spr,sspr,pset,camera
   
	-- 3d camera position
	local cam={x=0,y=0,z=0}
   
	-- is 3d mode enabled?
	is3d=false
   
	-- helper functions
   
	-- screen to camera space
	local function s2c(x,y,z)
	 return x-cam.x,y-cam.y,z-cam.z
	end
   
	-- perspective projection
	local function proj(x,y,z)
	 if -y>=p3d.near then
	  local scale=p3d.d/-y
	  return x*scale+p3d.vanish.x,-z*scale+p3d.vanish.y,scale
	 end
	end
   
	-- screen to projected
	local function s2p(x,y,z)
	 local x,y,z=s2c(x,y,z)
	 return proj(x,y,z)
	end
   
	-- 3d drawing fns
	function sspr3d(sx,sy,sw,sh,x,y,z,w,h,fx,fy)
	 w=w or sw
	 h=h or sh
	 local px,py,scale=s2p(x,y,z)
   
	 if(not scale)return
	 local pw,ph=w*scale,h*scale
   
	 -- sub pixel stuff
	 local x0,x1=flr(px),flr(px+pw)
	 local y0,y1=flr(py),flr(py+ph)
	 sspr2d(sx,sy,sw,sh,x0,y0,x1-x0,y1-y0,fx,fy)
	end
   
	spr3d=function(n,x,y,z,w,h,fx,fy)
	 if(not z)return
	 -- convert to equivalent sspr() call
	 w=(w or 1)*8
	 h=(h or 1)*8
	 local sx,sy=flr(n%16)*8,flr(n/16)*8
	 sspr3d(sx,sy,w,h,x,y,z,w,h,fx,fy)
	end 
   
	function map3d(cx,cy,x,y,z,w,h,lyr)
	 if(not h)return
   
	 -- near/far corners
	 local fx,fy,fz=s2c(x,y,z)
	 local nx,ny,nz=s2c(x,y+h*8,z)
   
	 -- clip
	 ny=min(ny,-p3d.near)
	 if(fy>=ny)return
   
	 -- project
	 local npx,npy,nscale=proj(nx,ny,nz)
	 local fpx,fpy,fscale=proj(fx,fy,fz)
   
	 if npy<fpy then
	  local tx,ty,ts=npx,npy,nscale
	  npx,npy,nscale=fpx,fpy,fscale
	  fpx,fpy,fscale=tx,ty,ts
	 end
   
	 -- clamp
	 npy=min(npy,128)
	 fpy=max(fpy,0)
   
	 -- rasterise
	 local py=flr(npy)
	 while py>=fpy do
   
	  -- floor plane intercept
	  local g=(py-p3d.vanish.y)/p3d.d
	  local d=-nz/g  
   
	  -- map coords
	  local mx,my=cx,(-fy-d)/8+cy
   
	  -- project to get left/right
	  local lpx,lpy,lscale=proj(nx,-d,nz)
	  local rpx,rpy,rscale=proj(nx+w*8,-d,nz)
   
	  -- delta x
	  local dx=w/(rpx-lpx)
   
	  -- sub-pixel correction
	  local l,r=flr(lpx+0.5)+1,flr(rpx+0.5)
	  mx+=(l-lpx)*dx
   
	  -- render
	  tline(l,py,r,py,mx,my,dx,0,lyr)
   
	  py-=1
	 end 
	end 
   
	function map3dupright(cx,cy,x,y,z,w,h,lyr)
	 if(not h)return
	 local px,py,scale=s2p(x,y,z)
	 if(not scale)return
   
	 local pw,ph=w*8*scale,h*8*scale
   
	 -- texture step
	 local dx,dy=w/pw,h/ph
	 local mx,my=cx+0.0625,cy+0.0625
   
	 -- sub pixel stuff
	 local x0,x1=flr(px),flr(px+pw)
	 local y0,y1=flr(py),flr(py+ph)
	 mx+=(x0-px)*dx
	 my+=(y0-py)*dy  
   
	 if(x0>=x1 or y0>=y1)return
   
	 for y=y0,y1-1 do
	  tline(x0,y,x1,y,mx,my,dx,0,lyr)
	  my+=dy
	 end
	end
   
	function camera3d(x,y,z)
	 cam.x,cam.y,cam.z=x,y,z
	end
   
	-- "instant 3d" wrapper functions
	local function icamera(x,y)
	 cam.x=(x or 0)+64
	 cam.y=(y or 0)+128+p3d.camyoff
	 cam.z=p3d.camheight
	end
   
	local function isspr(sx,sy,sw,sh,x,y,w,h,fx,fy)
	 z=h or sh
	 y+=z
	 sspr3d(sx,sy,sw,sh,x,y,z,w,h,fx,fy)
	end
   
	local function ispr(n,x,y,w,h,fx,fy)
	 z=(h or 1)*8
	 y+=z
	 spr3d(n,x,y,z,w,h,fx,fy)
	end
   
	local function imap(cx,cy,x,y,w,h,lyr)
	 cx=cx or 0
	 cy=cy or 0
	 x=x or 0
	 y=y or 0
	 w=w or 128
	 h=h or 64
	 map3d(cx,cy,x,y,0,w,h,lyr)
	end
   
	function go3d()
	 camera,sspr,spr,map=icamera,isspr,ispr,imap
	 camera2d()
	 is3d=true
	end
   
	function go2d()
	 map,spr,sspr,pset,camera=map2d,spr2d,sspr2d,pset2d,camera2d
	 is3d=false
	end
   
	-- defaults
	icamera()
   end
   
   -- enable 3d mode
   go3d()
   menuitem(3,"3d",go3d)
   menuitem(2,"2d",go2d)
function _init()
	pal({[0]=0,1,2,3,4,5,6,7,8,9,10,131,12,13,14,139},1)

end
function _draw()
	cls()
	map(8,0)
	spr3d(16,64,64,rnd(1),2,2)
	--spr(16,64+(rnd(2)),64(rnd2),2,2)
	
end
__gfx__
0000000033333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333bbbbbbbb77777777
0000000033777733333773333777773337777733333777733777777333333333333333333333333333333333333333333333333333333333bbbbbbbb77777777
0070070037733773337773333333377333333773337737733773333333777733337777333777777333777773377333333377777333333333bbbbbbbb7bbbbbb7
0007700037733773333773333377773333377733377337733777773337733773333773333333377337733333377777733773333333333333bbbbbbbb7bbbbbb7
0007700037733773333773333773333333333773377777733333377337733773333773333377773333777333377337733377777333333333bbbbbbbb7bbbbbb7
0070070033777733337777333777777337777733333337733777773337733773333777333773333337733333377377333333377333333333bbbbbbbb7bbbbbb7
0000000033333333333333333333333333333333333333333333333333777733333773333377777333777773377773333777777333333333bbbbbbbb7bbbbbb7
0000000033333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333bbbbbbbb7bbbbbb7
0000000000000000000000000000000000000000000000000000000000000000333333377333333377777777777777777777777777bbbbbbbbbbbb7777777777
00000dddddd0000000000dddddd0000000000dddddd0000000000dddddd00000333333377333333377777777777777777777777777bbbbbbbbbbbb7777777777
0000daaaaaad00000000daaaaaad00000000daaaaaad00000000daaaaaad0000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
000daffffffad000000daffffffad000000daffffffad000000daffffffad000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
000dfaaaaaafd000000dfaaaaaafd000000dfaaaaaafd000000dfaaaaaafd000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
000daaaaaaaa5000000daaaaaaaa50000005aaaaaaaad0000005aaaaaaaad000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
000daaaaa6665000000daaaaa66650000005666aaaaad0000005666aaaaad000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
000daaa661765000000daaa661765000000567166aaad000000567166aaad000333333377333333377bbbbbbbbbbbb773333333377bbbbbbbbbbbb777bbbbbb7
0005666771765000000566677176500000056717766650000005671776665000777777777777777777bbbbbbbbbbbb7733333333bbbbbbbb7777777773333337
0000567777750000000056777775000000005777776500000000577777650000777777777777777777bbbbbbbbbbbb7733333333bbbbbbbb7777777773333337
0000255555520000000025555552000000002555555200000000255555520000773333337333333777bbbbbbbbbbbb7733333333bbbbbbbbbbbbbbbb73333337
0000227722220000000022772222000000002222772200000000222277220000773333337333333777bbbbbbbbbbbb7733333333bbbbbbbbbbbbbbbb73333337
0000027722200000000002772220000000000222772000000000022277200000773333337333333777bbbbbbbbbbbb7733333333bbbbbbbbbbbbbbbb73333337
00000c77c110000000000c77c11000000000011c77c000000000011c77c00000773333337333333777bbbbbbbbbbbb7733333333bbbbbbbbbbbbbbbb73333337
0000088876600000000008887660000000000667888000000000066788800000773333337333333777777777777777777777777777777777bbbbbbbb77777777
0000066660000000000006666000000000000006666000000000000666600000773333337333333777777777777777777777777777777777bbbbbbbb77777777
__map__
1a2e2e2929292929292929292929292929292929292929292929292929292929292e2e1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d07080d07090d070a0d070b0d070c0d070b0d070a0d07090d07080d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d02010d03010d04010d05010d06010d05010d04010d03010d02010d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d0e0e0d0d18190d18190d18190d18190d18190d18190d18190d18190d18190d0d0e0e1e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2a2d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2d2d2b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
